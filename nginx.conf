server {
    listen 80;
    server_name your-domain.com your-droplet-ip;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com your-droplet-ip;

    # SSL Configuration (update with your SSL certificate paths)
    # ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # For now, comment out SSL and use HTTP only
    # Uncomment the server block below for HTTP-only setup

    client_max_body_size 100M;

    # Static files
    location /static/ {
        alias /var/www/floodcontrol/floodcontrol_project2/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Media files
    location /media/ {
        alias /var/www/floodcontrol/floodcontrol_project2/media/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # API and main application
    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn/floodcontrol.sock;
        
        # CORS headers
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization";
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
        }
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}

# HTTP-only configuration (use this initially)
# server {
#     listen 80;
#     server_name your-domain.com your-droplet-ip;
#     
#     client_max_body_size 100M;
#     
#     location /static/ {
#         alias /var/www/floodcontrol/floodcontrol_project2/staticfiles/;
#         expires 30d;
#     }
#     
#     location /media/ {
#         alias /var/www/floodcontrol/floodcontrol_project2/media/;
#         expires 30d;
#     }
#     
#     location / {
#         include proxy_params;
#         proxy_pass http://unix:/run/gunicorn/floodcontrol.sock;
#     }
# }